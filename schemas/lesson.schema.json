{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://edu.local/schemas/lesson.schema.json",
  "title": "Normalized Lesson",
  "description": "Schema canônico para aulas normalizadas consumidas pelos renderizadores MD3.",
  "type": "object",
  "additionalProperties": true,
  "required": ["id", "title", "content"],
  "properties": {
    "formatVersion": {
      "type": "string",
      "enum": ["md3.lesson.v1"],
      "description": "Versão da estrutura de aula normalizada."
    },
    "id": {
      "type": "string",
      "pattern": "^lesson-[0-9]{2,}$",
      "description": "Identificador único da aula alinhado ao arquivo no disco (ex.: lesson-01)."
    },
    "slug": {
      "type": "string",
      "pattern": "^[a-z0-9]+(?:-[a-z0-9]+)*$",
      "description": "Slug amigável usado em rotas ou âncoras públicas."
    },
    "title": {
      "type": "string",
      "minLength": 1,
      "description": "Título apresentado na navegação e cabeçalho da aula."
    },
    "summary": {
      "type": "string",
      "minLength": 1,
      "description": "Descrição curta (1-2 parágrafos) que contextualiza a aula."
    },
    "objective": {
      "type": "string",
      "description": "Objetivo principal herdado do legado."
    },
    "objectives": {
      "type": "array",
      "items": {
        "type": "string",
        "minLength": 1
      },
      "minItems": 1,
      "uniqueItems": true,
      "description": "Lista de objetivos específicos alinhados à BNCC/ABED."
    },
    "competencies": {
      "type": "array",
      "items": {
        "type": "string",
        "minLength": 1
      },
      "minItems": 1,
      "uniqueItems": true,
      "description": "Competências estruturantes trabalhadas na aula."
    },
    "skills": {
      "type": "array",
      "items": {
        "type": "string",
        "minLength": 1
      },
      "minItems": 1,
      "uniqueItems": true,
      "description": "Habilidades mensuráveis que o estudante deve demonstrar."
    },
    "outcomes": {
      "type": "array",
      "items": {
        "type": "string",
        "minLength": 1
      },
      "minItems": 1,
      "uniqueItems": true,
      "description": "Resultados de aprendizagem observáveis usados em avaliações."
    },
    "prerequisites": {
      "type": "array",
      "items": {
        "type": "string",
        "minLength": 1
      },
      "minItems": 1,
      "uniqueItems": true,
      "description": "Tópicos ou materiais que o estudante precisa revisar antes da aula."
    },
    "tags": {
      "type": "array",
      "items": {
        "type": "string",
        "pattern": "^[a-z0-9]+(?:-[a-z0-9]+)*$"
      },
      "uniqueItems": true,
      "description": "Marcadores usados em filtros e relatórios."
    },
    "duration": {
      "type": "number",
      "exclusiveMinimum": 0,
      "description": "Duração estimada em minutos para atividades síncronas/assíncronas."
    },
    "modality": {
      "type": "string",
      "enum": ["in-person", "remote", "hybrid", "async"],
      "description": "Modalidade principal de entrega da aula."
    },
    "resources": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "additionalProperties": true,
        "required": ["label", "url"],
        "properties": {
          "label": {
            "type": "string",
            "minLength": 1
          },
          "url": {
            "type": "string",
            "format": "uri"
          },
          "type": {
            "type": "string",
            "minLength": 1
          }
        }
      },
      "description": "Materiais complementares obrigatórios da aula."
    },
    "bibliography": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "string",
        "minLength": 1
      },
      "description": "Referências bibliográficas formatadas."
    },
    "assessment": {
      "type": "object",
      "additionalProperties": true,
      "properties": {
        "type": {
          "type": "string",
          "minLength": 1
        },
        "description": {
          "type": "string",
          "minLength": 1
        },
        "rubric": {
          "type": "string",
          "minLength": 1
        }
      },
      "description": "Resumo da estratégia avaliativa vinculada à aula."
    },
    "content": {
      "type": "array",
      "minItems": 1,
      "description": "Blocos semânticos renderizados pelos componentes MD3.",
      "items": {
        "$ref": "#/$defs/contentBlock"
      }
    },
    "metadata": {
      "type": "object",
      "additionalProperties": true,
      "properties": {
        "status": {
          "type": "string",
          "enum": ["draft", "in-review", "published"]
        },
        "updatedAt": {
          "type": "string",
          "format": "date-time"
        },
        "owners": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "minItems": 1,
          "uniqueItems": true
        },
        "sources": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "uniqueItems": true
        }
      },
      "description": "Metadados operacionais usados por governança e pipelines."
    }
  },
  "$defs": {
    "contentBlock": {
      "type": "object",
      "additionalProperties": true,
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "minLength": 1,
          "description": "Identificador do componente responsável por renderizar o bloco."
        }
      },
      "allOf": [
        { "$ref": "#/$defs/definitionCardBlock" },
        { "$ref": "#/$defs/comparativeTableBlock" },
        { "$ref": "#/$defs/systemDiagramBlock" },
        { "$ref": "#/$defs/codeChallengeBlock" },
        { "$ref": "#/$defs/memoryVisualizerBlock" },
        { "$ref": "#/$defs/caseStudyBlock" },
        { "$ref": "#/$defs/statCardBlock" },
        { "$ref": "#/$defs/knowledgeCheckBlock" },
        { "$ref": "#/$defs/interactiveDemoBlock" },
        { "$ref": "#/$defs/pedagogicalNoteBlock" },
        { "$ref": "#/$defs/promptTipBlock" },
        { "$ref": "#/$defs/codeSubmissionBlock" },
        { "$ref": "#/$defs/dragAndDropBlock" },
        { "$ref": "#/$defs/conceptMapperBlock" },
        { "$ref": "#/$defs/bugFixChallengeBlock" },
        { "$ref": "#/$defs/dataEntryFormBlock" },
        { "$ref": "#/$defs/scenarioBuilderBlock" },
        { "$ref": "#/$defs/peerReviewTaskBlock" },
        { "$ref": "#/$defs/testGeneratorBlock" },
        { "$ref": "#/$defs/rubricDisplayBlock" },
        { "$ref": "#/$defs/selfAssessmentBlock" },
        { "$ref": "#/$defs/dualAssessmentBlock" }
      ]
    },
    "dualAssessmentBlock": {
      "if": {
        "properties": { "type": { "const": "dualAssessment" } }
      },
      "then": {
        "required": ["theory", "practice"],
        "properties": {
          "title": { "type": "string" },
          "summary": { "type": "string" },
          "theory": {
            "type": "object",
            "allOf": [{ "$ref": "#/$defs/knowledgeCheckBlock/then" }],
            "properties": {
              "type": { "const": "knowledgeCheck" }
            }
          },
          "practice": {
            "type": "object",
            "allOf": [{ "$ref": "#/$defs/codeSubmissionBlock/then" }],
            "properties": {
              "type": { "const": "codeSubmission" }
            }
          }
        }
      }
    },
    "definitionCardBlock": {
      "if": {
        "properties": { "type": { "const": "definitionCard" } }
      },
      "then": {
        "required": ["term", "definition"],
        "properties": {
          "term": { "type": "string", "minLength": 1 },
          "definition": { "type": "string", "minLength": 1 },
          "source": { "type": "string", "minLength": 1 },
          "sourceUrl": { "type": "string", "format": "uri" }
        }
      }
    },
    "comparativeTableBlock": {
      "if": {
        "properties": { "type": { "const": "comparativeTable" } }
      },
      "then": {
        "required": ["headers", "rows"],
        "properties": {
          "title": { "type": "string" },
          "description": { "type": "string" },
          "caption": { "type": "string" },
          "leadingColumnLabel": { "type": "string" },
          "headers": {
            "type": "array",
            "minItems": 1,
            "items": { "type": "string", "minLength": 1 }
          },
          "rows": {
            "type": "array",
            "minItems": 1,
            "items": {
              "type": "object",
              "required": ["label", "values"],
              "properties": {
                "label": { "type": "string", "minLength": 1 },
                "values": {
                  "type": "array",
                  "minItems": 1,
                  "items": { "type": "string" }
                }
              }
            }
          }
        }
      }
    },
    "systemDiagramBlock": {
      "if": {
        "properties": { "type": { "const": "systemDiagram" } }
      },
      "then": {
        "required": ["nodes"],
        "properties": {
          "title": { "type": "string" },
          "summary": { "type": "string" },
          "nodes": {
            "type": "array",
            "minItems": 1,
            "items": {
              "type": "object",
              "required": ["id", "label"],
              "properties": {
                "id": { "type": "string", "minLength": 1 },
                "label": { "type": "string", "minLength": 1 },
                "description": { "type": "string" }
              }
            }
          },
          "connections": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["from", "to"],
              "properties": {
                "from": { "type": "string", "minLength": 1 },
                "to": { "type": "string", "minLength": 1 },
                "label": { "type": "string" }
              }
            }
          },
          "legend": {
            "type": "array",
            "items": { "type": "string" }
          }
        }
      }
    },
    "codeChallengeBlock": {
      "if": {
        "properties": { "type": { "const": "codeChallenge" } }
      },
      "then": {
        "required": ["prompt"],
        "properties": {
          "title": { "type": "string" },
          "prompt": { "type": "string", "minLength": 1 },
          "code": { "type": "string" },
          "language": { "type": "string" },
          "question": { "type": "string" },
          "options": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["id", "text"],
              "properties": {
                "id": { "type": "string", "minLength": 1 },
                "text": { "type": "string", "minLength": 1 }
              }
            }
          },
          "answerExplanation": { "type": "string" }
        }
      }
    },
    "memoryVisualizerBlock": {
      "if": {
        "properties": { "type": { "const": "memoryVisualizer" } }
      },
      "then": {
        "properties": {
          "title": { "type": "string" },
          "summary": { "type": "string" },
          "stack": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["label", "value"],
              "properties": {
                "label": { "type": "string" },
                "value": { "type": "string" }
              }
            }
          },
          "heap": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["label", "value"],
              "properties": {
                "label": { "type": "string" },
                "value": { "type": "string" }
              }
            }
          },
          "notes": { "type": "string" }
        }
      }
    },
    "caseStudyBlock": {
      "if": {
        "properties": { "type": { "const": "caseStudy" } }
      },
      "then": {
        "required": ["scenario"],
        "properties": {
          "title": { "type": "string" },
          "scenario": { "type": "string", "minLength": 1 },
          "background": { "type": "string" },
          "dataPoints": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["label", "value"],
              "properties": {
                "label": { "type": "string" },
                "value": { "type": "string" }
              }
            }
          },
          "questions": {
            "type": "array",
            "items": { "type": "string" }
          },
          "tasks": {
            "type": "array",
            "items": { "type": "string" }
          }
        }
      }
    },
    "statCardBlock": {
      "if": {
        "properties": { "type": { "const": "statCard" } }
      },
      "then": {
        "required": ["label", "value"],
        "properties": {
          "label": { "type": "string" },
          "value": { "type": "string" },
          "context": { "type": "string" },
          "source": { "type": "string" },
          "trend": { "type": "string", "enum": ["up", "down", "neutral"] }
        }
      }
    },
    "knowledgeCheckBlock": {
      "if": {
        "properties": { "type": { "const": "knowledgeCheck" } }
      },
      "then": {
        "required": ["prompt", "options"],
        "properties": {
          "title": { "type": "string" },
          "prompt": { "type": "string" },
          "options": {
            "type": "array",
            "minItems": 1,
            "items": {
              "type": "object",
              "required": ["id", "text"],
              "properties": {
                "id": { "type": "string", "minLength": 1 },
                "text": { "type": "string", "minLength": 1 }
              }
            }
          },
          "explanation": { "type": "string" },
          "allowMultiple": { "type": "boolean" }
        }
      }
    },
    "interactiveDemoBlock": {
      "if": {
        "properties": { "type": { "const": "interactiveDemo" } }
      },
      "then": {
        "required": ["url"],
        "properties": {
          "title": { "type": "string" },
          "description": { "type": "string" },
          "url": { "type": "string", "format": "uri" },
          "height": { "type": "number", "exclusiveMinimum": 0 }
        }
      }
    },
    "pedagogicalNoteBlock": {
      "if": {
        "properties": { "type": { "const": "pedagogicalNote" } }
      },
      "then": {
        "required": ["content"],
        "properties": {
          "title": { "type": "string" },
          "content": { "type": "string", "minLength": 1 },
          "audience": { "type": "string", "enum": ["teacher", "student", "team"] }
        }
      }
    },
    "promptTipBlock": {
      "if": {
        "properties": { "type": { "const": "promptTip" } }
      },
      "then": {
        "required": ["prompt"],
        "properties": {
          "title": { "type": "string" },
          "description": { "type": "string" },
          "prompt": { "type": "string", "minLength": 1 },
          "tips": {
            "type": "array",
            "items": { "type": "string", "minLength": 1 }
          },
          "tags": {
            "type": "array",
            "items": { "type": "string", "minLength": 1 },
            "uniqueItems": true
          },
          "audience": { "type": "string" }
        }
      }
    },
    "codeSubmissionBlock": {
      "if": {
        "properties": { "type": { "const": "codeSubmission" } }
      },
      "then": {
        "required": ["prompt"],
        "properties": {
          "title": { "type": "string" },
          "prompt": { "type": "string", "minLength": 1 },
          "language": { "type": "string" },
          "boilerplate": { "type": "string" },
          "tests": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["name"],
              "properties": {
                "name": { "type": "string", "minLength": 1 },
                "input": { "type": "string" },
                "expectedOutput": { "type": "string" }
              }
            }
          },
          "tips": {
            "type": "array",
            "items": { "type": "string" }
          }
        }
      }
    },
    "dragAndDropBlock": {
      "if": {
        "properties": { "type": { "const": "dragAndDrop" } }
      },
      "then": {
        "required": ["steps"],
        "properties": {
          "title": { "type": "string" },
          "instructions": { "type": "string" },
          "steps": {
            "type": "array",
            "minItems": 1,
            "items": {
              "type": "object",
              "required": ["id", "label"],
              "properties": {
                "id": { "type": "string", "minLength": 1 },
                "label": { "type": "string", "minLength": 1 },
                "description": { "type": "string" }
              }
            }
          }
        }
      }
    },
    "conceptMapperBlock": {
      "if": {
        "properties": { "type": { "const": "conceptMapper" } }
      },
      "then": {
        "required": ["nodes"],
        "properties": {
          "title": { "type": "string" },
          "description": { "type": "string" },
          "nodes": {
            "type": "array",
            "minItems": 1,
            "items": {
              "type": "object",
              "required": ["id", "label"],
              "properties": {
                "id": { "type": "string" },
                "label": { "type": "string" },
                "category": { "type": "string" },
                "details": { "type": "string" }
              }
            }
          },
          "relationships": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["from", "to"],
              "properties": {
                "from": { "type": "string" },
                "to": { "type": "string" },
                "label": { "type": "string" }
              }
            }
          }
        }
      }
    },
    "bugFixChallengeBlock": {
      "if": {
        "properties": { "type": { "const": "bugFixChallenge" } }
      },
      "then": {
        "required": ["code"],
        "properties": {
          "title": { "type": "string" },
          "description": { "type": "string" },
          "code": { "type": "string", "minLength": 1 },
          "language": { "type": "string" },
          "hints": {
            "type": "array",
            "items": { "type": "number" }
          },
          "guidance": {
            "type": "array",
            "items": { "type": "string" }
          }
        }
      }
    },
    "dataEntryFormBlock": {
      "if": {
        "properties": { "type": { "const": "dataEntryForm" } }
      },
      "then": {
        "required": ["fields"],
        "properties": {
          "title": { "type": "string" },
          "description": { "type": "string" },
          "submitLabel": { "type": "string" },
          "fields": {
            "type": "array",
            "minItems": 1,
            "items": {
              "type": "object",
              "required": ["id", "label"],
              "properties": {
                "id": { "type": "string", "minLength": 1 },
                "label": { "type": "string", "minLength": 1 },
                "type": {
                  "type": "string",
                  "enum": ["text", "number", "email", "date", "select"]
                },
                "required": { "type": "boolean" },
                "options": {
                  "type": "array",
                  "items": { "type": "string" }
                },
                "placeholder": { "type": "string" }
              }
            }
          }
        }
      }
    },
    "scenarioBuilderBlock": {
      "if": {
        "properties": { "type": { "const": "scenarioBuilder" } }
      },
      "then": {
        "required": ["inputs", "processes", "outputs"],
        "properties": {
          "title": { "type": "string" },
          "description": { "type": "string" },
          "inputs": { "type": "array", "items": { "type": "string" } },
          "processes": { "type": "array", "items": { "type": "string" } },
          "outputs": { "type": "array", "items": { "type": "string" } },
          "guidingQuestions": { "type": "array", "items": { "type": "string" } }
        }
      }
    },
    "peerReviewTaskBlock": {
      "if": {
        "properties": { "type": { "const": "peerReviewTask" } }
      },
      "then": {
        "required": ["criteria"],
        "properties": {
          "title": { "type": "string" },
          "description": { "type": "string" },
          "dueDate": { "type": "string" },
          "criteria": {
            "type": "array",
            "minItems": 1,
            "items": {
              "type": "object",
              "required": ["id", "label"],
              "properties": {
                "id": { "type": "string" },
                "label": { "type": "string" },
                "description": { "type": "string" }
              }
            }
          },
          "steps": { "type": "array", "items": { "type": "string" } }
        }
      }
    },
    "testGeneratorBlock": {
      "if": {
        "properties": { "type": { "const": "testGenerator" } }
      },
      "then": {
        "required": ["tags"],
        "properties": {
          "title": { "type": "string" },
          "description": { "type": "string" },
          "tags": {
            "type": "array",
            "minItems": 1,
            "items": { "type": "string", "minLength": 1 }
          },
          "difficulties": {
            "type": "array",
            "items": {
              "type": "string",
              "enum": ["easy", "medium", "hard"]
            }
          }
        }
      }
    },
    "rubricDisplayBlock": {
      "if": {
        "properties": { "type": { "const": "rubricDisplay" } }
      },
      "then": {
        "required": ["criteria"],
        "properties": {
          "title": { "type": "string" },
          "description": { "type": "string" },
          "criteria": {
            "type": "array",
            "minItems": 1,
            "items": {
              "type": "object",
              "required": ["criterion", "levels"],
              "properties": {
                "criterion": { "type": "string", "minLength": 1 },
                "levels": {
                  "type": "array",
                  "minItems": 1,
                  "items": {
                    "type": "object",
                    "required": ["level", "description"],
                    "properties": {
                      "level": { "type": "string" },
                      "description": { "type": "string" }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "selfAssessmentBlock": {
      "if": {
        "properties": { "type": { "const": "selfAssessment" } }
      },
      "then": {
        "required": ["prompts"],
        "properties": {
          "title": { "type": "string" },
          "description": { "type": "string" },
          "prompts": {
            "type": "array",
            "minItems": 1,
            "items": {
              "type": "object",
              "required": ["id", "label"],
              "properties": {
                "id": { "type": "string", "minLength": 1 },
                "label": { "type": "string", "minLength": 1 },
                "placeholder": { "type": "string" }
              }
            }
          }
        }
      }
    }
  }
}
